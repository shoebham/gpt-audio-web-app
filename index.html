<!DOCTYPE html>
<html>

<head>
    <title>Speech to Text</title>
</head>

<body>
    <h1>Speech to Text</h1>

    <button id="startButton">Start</button>
    <button id="stopButton">Stop</button>

    <div id="transcript"></div>

    <script src="/socket.io/socket.io.js"></script>
    
    <div id="speech-text">
        Text from Speech:
    </div>
    <div id="helper">
        
    </div>
    <div id="gpt-response">
    </div>
</body>
<script>
    // Connect to the Socket.IO server
    const socket = io();

    // Get DOM elements
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const transcriptDiv = document.getElementById('transcript');
    const helperDiv = document.getElementById('helper');
    // Speech recognition variables
    let recognition;
    let transcript = "";
    // Check if browser supports SpeechRecognition
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        // Start speech recognition
        startButton.addEventListener('click', () => {
            recognition.start();
        });

        // Stop speech recognition
        // stopButton.addEventListener('click', () => {
        //     recognition.stop();
        // });

        // Speech recognition event listeners
        recognition.onstart = () => {
            console.log('Speech recognition started');
        };

        recognition.onresult = (event) => {
            transcript = Array.from(event.results)
                .map((result) => result[0].transcript)
                .join('');

            console.log('Transcript:', transcript);
            document.getElementById("speech-text").innerHTML = "Speech Text: " + transcript;
            // transcript="";
            // Emit the transcript to the server
        };
        recognition.onspeechend = () => {
            helperDiv.innerHTML = "Detected silence for 5 seconds, so processing speech";
            console.log('Speech recognition ended');
            // create a sending animation with ...
            helperDiv.innerHTML = "Sending to GPT-3...";
        };
        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
        };

        recognition.onend = () => {

            helperDiv.innerHTML = "Detected silence for 5 seconds, so processing speech";
            socket.emit('voiceInput', transcript);
            transcript = "";
            console.log('Speech recognition ended');
            // create a sending animation with ...
            // helperDiv.innerHTML = "Sending to GPT-3...";
        };
    } else {
        console.error('Speech recognition not supported');
    }

    // Socket.IO event listeners
    socket.on('connect', () => {
        console.log('Connected to server');
    });

    socket.on('audioResponse', (response) => {
        helperDiv.innerHTML = "";
        console.log('Audio response:', response);
        document.getElementById("gpt-response").innerHTML = "GPT response:" + response;
        // Display the response on the page

    });

    socket.on('disconnect', () => {
        console.log('Disconnected from server');
    });
</script>

</html>